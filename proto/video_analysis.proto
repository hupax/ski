syntax = "proto3";

option java_multiple_files = true;
option java_package = "com.skiuo.grpc";
option java_outer_classname = "VideoAnalysisProto";

package videoanalysis;

// Video Analysis Service
service VideoAnalysisService {
  // Step 1: Process video (FFmpeg slicing)
  // Returns local file paths of sliced windows
  rpc ProcessVideo(ProcessRequest) returns (ProcessResponse);

  // Step 2: Analyze video (Call AI API)
  // Streams back AI analysis results
  rpc AnalyzeVideo(AnalysisRequest) returns (stream AnalysisResponse);

  // Step 3: Extract video tail (for cross-chunk windows)
  // Extracts last N seconds from a video
  rpc ExtractTail(ExtractTailRequest) returns (ExtractTailResponse);

  // Step 4: Concatenate videos (for cross-chunk windows)
  // Joins multiple videos into one
  rpc ConcatVideos(ConcatVideosRequest) returns (ConcatVideosResponse);

  // Step 5: Extract video segment (for master video sliding window)
  // Extracts a specific time range from video
  rpc ExtractSegment(ExtractSegmentRequest) returns (ExtractSegmentResponse);

  // Step 6: Get video duration
  // Returns the duration of a video file
  rpc GetVideoDuration(GetVideoDurationRequest) returns (GetVideoDurationResponse);

  // Step 7: Generate session title
  // Generates a concise title (<=10 chars) based on all analysis results
  rpc GenerateTitle(GenerateTitleRequest) returns (GenerateTitleResponse);

  // Step 8: Refine analysis result
  // Fixes obvious errors in the analysis result
  rpc RefineAnalysis(RefineAnalysisRequest) returns (RefineAnalysisResponse);

  // Step 9: Extract user memory
  // Extracts user habits, knowledge, and behavior patterns from analysis
  rpc ExtractUserMemory(ExtractUserMemoryRequest) returns (ExtractUserMemoryResponse);
}

// ========== Process Video Messages ==========

message ProcessRequest {
  string session_id = 1;           // Session ID
  int64 chunk_id = 2;              // Chunk ID in database
  string video_path = 3;           // Local file path (same server)
  string analysis_mode = 4;        // "full" or "sliding_window"
  int32 window_size = 5;           // Sliding window size in seconds (default 15)
  int32 window_step = 6;           // Sliding step size in seconds (default 10)
}

message ProcessResponse {
  repeated WindowInfo windows = 1;  // List of sliced window information
  string error = 2;                 // Error message if any
}

// Window information with time range
message WindowInfo {
  string path = 1;                  // Local file path
  float start_time = 2;             // Start time in seconds (relative to video start)
  float end_time = 3;               // End time in seconds (relative to video start)
  float duration = 4;               // Actual duration in seconds
}

// ========== Analyze Video Messages ==========

message AnalysisRequest {
  string session_id = 1;           // Session ID
  int32 window_index = 2;          // Window index for identification
  string video_url = 3;            // MinIO presigned URL (core)
  string ai_model = 4;             // "qwen" or "gemini"
  string context = 5;              // Previous window result summary
  int32 start_offset = 6;          // Start time offset in seconds
  int32 end_offset = 7;            // End time offset in seconds
  string analysis_mode = 8;        // "full" or "sliding_window" - determines prompt selection
  string user_memory = 9;          // User memory JSON string (habits, knowledge, behavior patterns)
}

message AnalysisResponse {
  string session_id = 1;           // Session ID
  int32 window_index = 2;          // Window index
  string content = 3;              // Streaming token content
  bool is_final = 4;               // Whether this is the last message
  string error = 5;                // Error message if any
}

// ========== Extract Tail Messages ==========

message ExtractTailRequest {
  string video_path = 1;           // Input video file path
  string output_path = 2;          // Output tail file path
  int32 duration = 3;              // Duration to extract (last N seconds)
}

message ExtractTailResponse {
  string output_path = 1;          // Path to extracted tail file
  string error = 2;                // Error message if any
}

// ========== Concatenate Videos Messages ==========

message ConcatVideosRequest {
  repeated string video_paths = 1; // List of video paths to concatenate (in order)
  string output_path = 2;          // Output concatenated file path
}

message ConcatVideosResponse {
  string output_path = 1;          // Path to concatenated video
  string error = 2;                // Error message if any
}

// ========== Extract Segment Messages ==========

message ExtractSegmentRequest {
  string video_path = 1;           // Input video file path
  string output_path = 2;          // Output segment file path
  float start_time = 3;            // Start time in seconds
  float end_time = 4;              // End time in seconds
}

message ExtractSegmentResponse {
  string output_path = 1;          // Path to extracted segment file
  string error = 2;                // Error message if any
}

// ========== Get Video Duration Messages ==========

message GetVideoDurationRequest {
  string video_path = 1;           // Input video file path
}

message GetVideoDurationResponse {
  float duration = 1;              // Video duration in seconds
  string error = 2;                // Error message if any
}

// ========== Generate Title Messages ==========

message GenerateTitleRequest {
  string session_id = 1;           // Session ID
  repeated string analysis_results = 2;  // All refined analysis results
  string user_memory = 3;          // User memory JSON string
  string ai_model = 4;             // "qwen" or "gemini"
}

message GenerateTitleResponse {
  string title = 1;                // Generated title (<=10 characters)
  string error = 2;                // Error message if any
}

// ========== Refine Analysis Messages ==========

message RefineAnalysisRequest {
  string session_id = 1;           // Session ID
  int32 window_index = 2;          // Window index
  string raw_content = 3;          // Raw analysis result to refine
  VideoMetadata metadata = 4;      // Video metadata (duration, etc.)
  string user_memory = 5;          // User memory JSON string
  string ai_model = 6;             // "qwen" or "gemini"
}

message RefineAnalysisResponse {
  string refined_content = 1;      // Refined analysis result
  string error = 2;                // Error message if any
}

// Video metadata for refinement (extensible)
message VideoMetadata {
  double video_duration = 1;       // Total video duration in seconds
  string resolution = 2;           // Video resolution (e.g., "1920x1080") - reserved
  string storage_type = 3;         // Storage type (e.g., "minio", "oss", "cos") - reserved
  map<string, string> custom = 4; // Custom metadata key-value pairs
}

// ========== Extract User Memory Messages ==========

message ExtractUserMemoryRequest {
  string session_id = 1;           // Session ID
  repeated string analysis_results = 2;  // All refined analysis results
  string current_memory = 3;       // Current user memory JSON string
  string ai_model = 4;             // "qwen" or "gemini"
}

message ExtractUserMemoryResponse {
  string new_memory = 1;           // Extracted new memory data (JSON string)
  string error = 2;                // Error message if any
}
